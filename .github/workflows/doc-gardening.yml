name: doc-gardening

on:
  schedule:
    # Weekly on Monday at 09:00 UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

env:
  UV_VERSION: "0.5.15"
  UV_CACHE_DIR: /tmp/.uv-cache

jobs:
  check-stale-docs:
    name: Check for Stale Documentation
    runs-on: ubuntu-24.04
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find modules not mentioned in architecture docs
        id: check
        run: |
          # Get all top-level packages under src/alpacalyzer/
          modules=$(find src/alpacalyzer -maxdepth 1 -type d -not -name __pycache__ -not -name src -not -name alpacalyzer | sed 's|src/alpacalyzer/||' | sort)

          missing=""
          for mod in $modules; do
            if [ -z "$mod" ]; then continue; fi
            # Check if module is mentioned in architecture overview
            if ! grep -qi "$mod" docs/architecture/overview.md 2>/dev/null; then
              missing="$missing\n- \`$mod\` not mentioned in \`docs/architecture/overview.md\`"
            fi
          done

          # Check for files modified in last 30 days with no doc updates
          recently_changed=$(git log --since="30 days ago" --name-only --pretty=format: -- 'src/alpacalyzer/**/*.py' | sort -u | head -20)
          doc_changes=$(git log --since="30 days ago" --name-only --pretty=format: -- 'docs/**/*.md' | sort -u)

          stale_modules=""
          for file in $recently_changed; do
            if [ -z "$file" ]; then continue; fi
            # Extract module name
            mod=$(echo "$file" | sed 's|src/alpacalyzer/||' | cut -d'/' -f1 | cut -d'.' -f1)
            if [ -z "$mod" ]; then continue; fi
            # Check if any doc mentions this module was updated recently
            if [ -z "$doc_changes" ]; then
              stale_modules="$stale_modules\n- \`$mod\` has code changes but no doc updates in last 30 days"
            fi
          done

          if [ -n "$missing" ] || [ -n "$stale_modules" ]; then
            echo "has_issues=true" >> "$GITHUB_OUTPUT"
            body="## Documentation Gardening Report\n\n"
            if [ -n "$missing" ]; then
              body="${body}### Modules Missing from Architecture Docs\n${missing}\n\n"
            fi
            if [ -n "$stale_modules" ]; then
              body="${body}### Potentially Stale Documentation\n${stale_modules}\n\n"
            fi
            body="${body}*Generated by doc-gardening workflow. See \`docs/principles.md\` for documentation standards.*"
            # Write body to file to handle multiline
            echo -e "$body" > /tmp/issue-body.txt
          else
            echo "has_issues=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create or update issue
        if: steps.check.outputs.has_issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('/tmp/issue-body.txt', 'utf8');
            const title = 'ðŸ“š Documentation gardening needed';
            const labels = ['documentation', 'automated'];

            // Check for existing open issue
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: labels.join(','),
            });

            const match = existing.data.find(i => i.title === title);
            if (match) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: match.number,
                body: body,
              });
              console.log(`Updated existing issue #${match.number}`);
            } else {
              const created = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: labels,
              });
              console.log(`Created issue #${created.data.number}`);
            }
